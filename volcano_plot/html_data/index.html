<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Zoomable Volcano Plot with Tooltips in D3 v4</title>
    <link rel="shortcut icon" href="#"> <!-- prevent "favicon.ico not found" error in console -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <!--
    <script src="https://eligrey.com/demos/FileSaver.js/Blob.js"></script>
    <script src="https://eligrey.com/demos/FileSaver.js/FileSaver.js"></script> -->
    <script type="text/javascript" src="https://cdn.rawgit.com/eligrey/canvas-toBlob.js/f1a01896135ab378aa5c0118eadd81da55e698d8/canvas-toBlob.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js" ></script>
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans:400,700" rel="stylesheet">
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <script src="index.js" type="text/javascript"></script>
</head>

<body>

    <div class="container">

        <div class="row">&nbsp;</div>

        <div class="row">
            <div class="col-sm-18">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Plot Title:</span>
                    </div>
                    <input type="text" class="form-control" aria-label="plottitle" id="plottitle" value="Title">
                </div>

                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">y axis:</span>
                    </div>
                    <input type="text" class="form-control" aria-label="plotyaxis" id="plotyaxis" value='-log<tspan baseline-shift="sub">10</tspan>False Discovery Rate'>
                </div>

                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">x axis:</span>
                    </div>
                    <input type="text" class="form-control" aria-label="plotxaxis" id="plotxaxis" value='log<tspan baseline-shift="sub">2</tspan>Fold-change'>
                    
                </div>
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">FDR threshold:</span>
                    </div>
                    <input type="text" class="form-control" aria-label="fdrthreshold" id="fdrthreshold" value="0.05">
                </div>

                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Fold-change threshold:</span>
                    </div>
                    <input type="text" class="form-control" aria-label="foldchange" id="foldchange" value="1">
                </div>

                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Color Mode (v1):</span>
                    </div>
                    <div class="btn-group btn-group-toggle" data-toggle="buttons">
                        <label class="btn btn-secondary active">
                        <input type="radio" name="options" id="colormode1" autocomplete="off" checked> Default (4 colors)
                        </label>
                        <label class="btn btn-secondary">
                        <input type="radio" name="options" id="colormode2" autocomplete="off"> Pos-Neg (2 colors)
                        </label>
                    </div>
                </div>
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Color Mode (v2):</span>
                    </div>
                    <div class="checkbox">
                        <input type="checkbox" data-on="4 color mode" data-off="2 color mode" id="colormodetoggle" checked data-toggle="toggle">
                    </div>  
                </div>
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Color Mode (v3):</span>
                    </div>
                    <select class="custom-select" id="inputGroupSelect01">
                    <!--<option selected>Choose...</option>-->
                    <option selected value="1">color mode 1 (4 colors)</option>
                    <option value="2">color mode 2 (2 colors)</option>
                    </select>
                </div>


                <!-- KEEP AT BOTTOM OF FORM -->
                <button type="button" class="btn btn-outline-primary" id="apply">Update Plot</button>

                <!-- export buttons should check form values against plot values. if any differences, give user option to download 'as is' or with form options applied-->
                <button type="button" class="btn btn-outline-primary" onclick="saveSvg()" id="exportsvg">Save as SVG</button>
                <button type="button" class="btn btn-outline-primary" id="savesvg">Save as SVG (d3)</button> 
                <button type="button" class="btn btn-outline-primary" id="generate">Save as SVG (d3-v3)</button>
                
            </div>
            <div class="col-sm">&nbsp; </div>
        </div>

        <div class="row">
            <div id="chart"></div>

        </div>

        <script  type="text/javascript">
            var yLabel = '-log<tspan baseline-shift="sub">10</tspan>False Discovery Rate', // needs to be variable set according to the workflow this plot is made for
                xLabel = 'log<tspan baseline-shift="sub">2</tspan>Fold-change',// needs to be variable set according to the workflow this plot is made for
                file = window.location.href.replace("index.html", "") + "/deseq_report.tsv"; // needs to be variable set according to the workflow this plot is made for

            var volcanoPlot = volcanoPlot()
                //.xAxisLabel(xLabel)
                //.yAxisLabel(yLabel)
                .foldChangeThreshold(1.0)
                .sampleID("GeneId")
                .xColumn("log2FoldChange") // needs to be variable set according to the workflow this plot is made for
                .yColumn("padj");// needs to be variable set according to the workflow this plot is made for

            d3.tsv(file, parser, function (error, data) {
                if (error) console.log(error);

                d3.select('#chart')
                    .data([data])
                    .call(volcanoPlot);
            });

            // row parser to convert key values into numbers if possible
            function parser(d) {
                for (var key in d) {
                    if (d.hasOwnProperty(key)) {
                        d[key] = numberParser(d[key]);
                    }
                }
                return d;
            }

            // function to turn string into number if possible
            function numberParser(value) {
                return (+value) ? +value : value;
            }

            function saveSvg(){
                /*
                //get svg element.
                var svg = document.getElementById("svg");

                //get svg source.
                var serializer = new XMLSerializer();
                var source = serializer.serializeToString(svg);

                //add name spaces.
                if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
                    source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
                }
                if(!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)){
                    source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
                }

                //add xml declaration
                source = '<?xml version="1.0" standalone="no"?>\r\n' + source;

                //convert svg source to URI data scheme.
                var url = "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(source);

                //set url value to a element's href attribute.
                document.getElementById("link").href = url;
                //you can download svg file by right click menu.
                */
                var svg = document.getElementById("svg");
                var serializer = new XMLSerializer();
                var source = serializer.serializeToString(svg);
                source = source.replace(/(\w+)?:?xlink=/g, 'xmlns:xlink='); // Fix root xlink without namespace

                source = source.replace(/ns\d+:href/g, 'xlink:href'); // Safari NS namespace fix.


                if (!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)) {
                    console.log('matched xmlns tag to format')
                    source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
                }
                if (!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)) {
                    console.log('matched svg tag to format')
                    source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
                }


                var preface = '<?xml version="1.0" standalone="no"?>\r\n';
                var svgBlob = new Blob([preface, source], { type: "image/svg+xml;charset=utf-8" });
                console.log('blob: ', svgBlob);
                var svgUrl = URL.createObjectURL(svgBlob);
                var downloadLink = document.createElement("a");
                downloadLink.href = svgUrl;
                downloadLink.download = "exampleSvg.svg";
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            }

            
        </script>

</body>

</html>